---
import qs from "qs";
import MainLayout from "../layouts/MainLayout.astro";
import MangaCard from "../components/MangaCard.astro";
import { getMangaQueryFromURLParam, getPagination } from "../lib/manga";
import { safeFetchWithSchema } from "../lib/fetcher";
import { API_ENDPOINTS, MetadataResponseSchema } from "@comic-viewer/shared";

const PAGINATION_LIMIT = 9;

const mangaQuery = getMangaQueryFromURLParam(Astro.url.searchParams);
const endpointWithQuery = `${import.meta.env.PUBLIC_API_URL}${API_ENDPOINTS.manga.list}?${qs.stringify(mangaQuery)}`;
const { pageConf, total, data } = await safeFetchWithSchema(endpointWithQuery, MetadataResponseSchema);
const pages = getPagination(pageConf, PAGINATION_LIMIT, total);
const currentPage = pageConf.page;
---

<MainLayout title="漫画一覧">
  <div id="manga-list-container">
    {
      data.map((dataItem) => {
        return <MangaCard manga={dataItem} />;
      })
    }
  </div>
  <div class="pagination" id="pagination">
    {
      pages.map((page) => {
        const urlParams = Astro.url.searchParams;
        urlParams.set("page", page.toString());
        const href = `?${urlParams.toString()}`;
        return (
          <a
            href={href}
            class={`pagination-button ${page === currentPage ? "active" : ""}`}
            aria-current={page === currentPage ? "page" : undefined}
          >
            {page}
          </a>
        );
      })
    }
  </div>

  <footer class="mangalist-footer">
    <div class="footer-info">
      <span id="manga-count">{total}件の漫画</span>
    </div>
  </footer>
</MainLayout>
<style is:global>
  @import "../styles/mangaList.css";
</style>
